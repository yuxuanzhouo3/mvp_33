# 在线状态功能改进设计

**日期**: 2026-02-28
**状态**: 已实施

## 背景

现有的在线状态功能存在以下问题：
1. Avatar 组件没有渲染在线状态指示器
2. API 缺少 `last_seen_at` 字段导致国内版判断失败
3. 心跳频率太低（60秒）导致状态更新不及时
4. 判断阈值太宽松（120秒）导致离线状态显示延迟

## 设计目标

- 简单模式：只有在线/离线两种状态
- Slack 风格：右下角绿色圆点
- 更快响应：30秒心跳，60秒判断阈值
- 修复现有 bug

## 改进方案

### 1. 视觉设计

**在线状态指示器**（Slack 风格）：
- 在线：头像右下角绿色实心圆点（`bg-green-500`）+ 白色边框（`ring-2 ring-white`）
- 离线：不显示任何指示器（更简洁）
- 尺寸：`h-2.5 w-2.5`（10px）
- 位置：`absolute bottom-0 right-0`

### 2. 心跳和判断参数

**国内版心跳机制**：
- 心跳频率：30 秒（从 60 秒改进）
- 判断阈值：60 秒（从 120 秒改进）
- 检查频率：15 秒（从 30 秒改进）

**效果**：
- 用户上线后 30 秒内显示在线
- 用户离线后 60 秒内显示离线
- 前端每 15 秒检查一次状态

### 3. 技术修复

**修复 1：Avatar 组件渲染**
- 添加在线状态圆点的 JSX 渲染
- 只在 `showOnlineStatus=true` 且 `isOnline=true` 时显示

**修复 2：API 返回字段**
- `/api/users/[id]` 添加 `last_seen_at` 字段
- 确保国内版可以正确获取最后在线时间

**修复 3：参数优化**
- `use-heartbeat.ts`: 心跳间隔改为 30000ms
- `use-online-status.ts`: 判断阈值改为 60000ms，检查间隔改为 15000ms

## 需要修改的文件

1. `components/ui/avatar.tsx` - 添加在线状态圆点渲染
2. `app/api/users/[id]/route.ts` - 添加 `last_seen_at` 字段（CloudBase 和 Supabase）
3. `hooks/use-heartbeat.ts` - 心跳间隔改为 30 秒
4. `hooks/use-online-status.ts` - 判断阈值改为 60 秒，检查间隔改为 15 秒

## 预期效果

- ✅ 在线用户头像右下角显示绿色圆点
- ✅ 离线用户不显示任何指示器
- ✅ 用户离线后 60 秒内状态更新
- ✅ 国内版和国际版体验一致
- ✅ 修复现有判断不准确的问题

## 实施注意事项

1. **最简原则**：只实现在线/离线两种状态，不添加额外复杂性
2. **向后兼容**：确保 API 修改不影响现有功能
3. **性能考虑**：30 秒心跳对服务器压力可接受
4. **错误处理**：确保网络错误不影响用户体验

## 后续优化（可选）

- 添加"离开"状态（一段时间无操作）
- 添加"忙碌"状态
- 优化心跳频率（根据用户活跃度动态调整）
